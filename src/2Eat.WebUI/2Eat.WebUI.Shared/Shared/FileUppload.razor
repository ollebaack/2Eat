@* @rendermode @(new InteractiveWebAssemblyRenderMode(false)) *@
@using System.Net.Http.Headers
@inject IClient Client
@inject IJSRuntime JS
@inject HttpClient Http

<h3>Lägg till en bild</h3>

<InputFile OnChange="OnInputFileChange"/>

@if (fileNames.Count > 0)
{
    <ul>
        @foreach (var fileName in fileNames)
        {
            @if (!string.IsNullOrWhiteSpace(fileName))
            {
                <img id="imgHolder" src="@imgSrc" width="400"/>
                @* <button @onclick="@(()=> StreamFileAsync(uploadResult?.StoredFileName, fileName))">Stream file</button> *@
            }
        }
    </ul>
}

@code {
    private int maxAllowedFiles = 1;
    private long maxFileSize = 10 * 1024 * 1024; // 10MB
    private List<string> fileNames = new List<string>();
    private FileUpload? uploadResult = new FileUpload();
    private string? imgSrc = string.Empty;

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        using var content = new MultipartFormDataContent();
        var fileContent = new StreamContent(e.File.OpenReadStream(maxFileSize));
        fileContent.Headers.ContentType = new MediaTypeHeaderValue(e.File.ContentType);

        fileNames.Add(e.File.Name);

        content.Add(
            content: fileContent,
            name: "file",
            fileName: e.File.Name);

        Client.SetEntityEndpoint("files");
        uploadResult = await Client.CreateAsync<FileUpload, MultipartFormDataContent>(content);
        imgSrc = await StreamFileAsync(uploadResult.StoredFileName, uploadResult.FileName);
    }

    private async Task<string> GetImg(string storedFileName)
    {
        Client.SetEntityEndpoint("files");
        var fileUpload = await Client.GetByNameAsync<FileUpload>(storedFileName);
        return $"../{storedFileName}";
    }

    private async Task<string> StreamFileAsync(string storedFileName, string originalFileName)
    {
        @* Client.SetEntityEndpoint("files"); *@
        var response = await Http.GetAsync($"api/files/{storedFileName}");
        if (response.IsSuccessStatusCode)
        {
            var fileStream = await response.Content.ReadAsStreamAsync();
            using var streamRef = new DotNetStreamReference(fileStream);
            @* await JS.InvokeVoidAsync("IMAGE_STREAMER.UpdateImg", "imgHolder", streamRef); *@
            string test = await JS.InvokeAsync<string>("IMAGE_STREAMER.GetImgSrc", streamRef);
            return test;
            @* await JS.InvokeVoidAsync("IMAGE_STREAMER.DownloadFileFromStream", originalFileName, streamRef); *@
        }
        return string.Empty;
        
    }
    private async Task DownloadFile(string storedFileName, string originalFileName)
    {
        Client.SetEntityEndpoint("files");
        var fileUpload = await Client.GetByNameAsync<FileUpload>(storedFileName);

        // var 

        await JS.InvokeVoidAsync("downloadFile", storedFileName, originalFileName);
    }
}