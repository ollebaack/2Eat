@page "/recipe"
@page "/recipe/{Id:int}/edit"

@rendermode @(new InteractiveWebAssemblyRenderMode(false))
@attribute [StreamRendering]
@inject IRecipeService RecipeService
@inject NavigationManager NavigationManager

@if (Id.HasValue)
{
    <PageTitle>Recept</PageTitle>
    @if (isEditingName)
    {
        <EditForm Model="recipe" OnSubmit="HandleSubmit">
            <InputText @bind-Value="recipe.Name" class="form-control" />
        </EditForm>
    }
    else
    {
        <h3>@recipe.Name <i class="fas fa-pencil-alt fa-xs" @onclick="() => isEditingName = true"></i></h3>
    }
}
else
{
    <PageTitle>Skapa Recept</PageTitle>
    <h3>Skapa Recept</h3>
}
<hr />

<FileUppload></FileUppload>
@if (recipe.ImageUrl is not null)
{
    <p>
        <img src="@recipe.ImageUrl" />
    </p>
}

@if (!Id.HasValue)
{
    <EditForm Model="recipe" OnSubmit="HandleSubmit">
        <InputText @bind-Value="recipe.Name">@recipe.Name</InputText>
    </EditForm>
    <hr />
}

<RecipeIngredients @bind-IngredientsList="recipe.Ingredients" Edit=true />

<h5>Instructions</h5>
<EditForm Model="recipe" OnSubmit="HandleSubmit">
    <InputTextArea @bind-Value="recipe.Instructions">@recipe.Instructions</InputTextArea>
    <br />
    <button type="submit" class="btn btn-primary">Save</button>
</EditForm>

@code {
    [Parameter]
    public int? Id { get; set; }

    private string ingredient = string.Empty;
    private Recipe recipe = new Recipe();
    private bool isEditingName = false;


    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            recipe = await RecipeService.GetRecipeByIdAsync(Id.Value) ?? throw new Exception($"{nameof(recipe)} was null.");
        }
    }

    protected async Task HandleSubmit()
    {
        if (Id.HasValue)
        {
            recipe = await RecipeService.UpdateRecipeAsync(Id.Value, recipe);
            isEditingName = false;
        }
        else
        {
            recipe = await RecipeService.AddRecipeAsync(recipe);
        }

        NavigationManager.NavigateTo($"/recipe/{recipe.Id}");
    }
}